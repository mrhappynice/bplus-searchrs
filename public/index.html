<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>bplusü§∑‚Äç‚ôÇÔ∏èÔ∏è Search</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <style>
            :root {
                --bg-color: #1a1a1a;
                --text-color: #e0e0e0;
                --container-bg: #2d2d2d;
                --border-color: #444;
                --primary-color: #64b5f6;
                --button-hover-bg: #42a5f5;
                --disabled-color: #555;
                --link-color: #90caf9;
                --code-bg: #3c3c3c;
                --panel-bg: #252526;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                line-height: 1.6;
                margin: 0;
                display: flex;
                height: 100vh;
                overflow: hidden;
                background-color: var(--bg-color);
                color: var(--text-color);
            }

            /* --- Panels --- */
            #research-panel,
            #settings-panel {
                position: fixed;
                top: 0;
                width: 320px;
                height: 100%;
                background-color: var(--panel-bg);
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                padding: 15px;
                box-sizing: border-box;
                transition: transform 0.3s ease;
                z-index: 1000;
                display: flex;
                flex-direction: column;
            }

            #research-panel {
                left: 0;
                transform: translateX(-100%);
            }
            #research-panel.visible {
                transform: translateX(0);
            }

            #settings-panel {
                right: 0;
                transform: translateX(100%);
            }
            #settings-panel.visible {
                transform: translateX(0);
            }

            .panel-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            .panel-header h2,
            .panel-header h3 {
                margin: 0;
            }
            .close-panel-btn {
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 24px;
                cursor: pointer;
            }

            main {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                height: 100vh;
                transition:
                    margin-left 0.3s ease,
                    margin-right 0.3s ease;
            }

            #chat-container {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
            }
            #chat-log {
                max-width: 800px;
                margin: 0 auto;
            }

            .message {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 1rem;
                background-color: var(--container-bg);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            .message.user {
                background-color: #333;
            }
            .message .content {
                white-space: pre-wrap;
            }
            .message .content p,
            .message .content ul,
            .message .content ol,
            .message .content h1,
            .message .content h2,
            .message .content h3 {
                margin: 0.01em 0;
            }
            .message .content code {
                background-color: var(--code-bg);
                padding: 2px 4px;
                border-radius: 4px;
            }
            .message .content pre {
                background-color: var(--code-bg);
                padding: 2px;
                border-radius: 0.5px;
                overflow-x: auto;
            }

            .sources-container {
                margin-top: 15px;
                border-top: 1px solid var(--border-color);
                padding-top: 10px;
            }
            .sources-toggle {
                font-weight: bold;
                cursor: pointer;
                color: var(--primary-color);
            }
            .sources-list {
                display: none;
                margin-top: 10px;
            }
            a {
                color: inherit;
                text-decoration: none;
            }

            a {
                background:
                    linear-gradient(
                        to right,
                        rgba(100, 200, 200, 1),
                        rgba(100, 200, 200, 1)
                    ),
                    linear-gradient(
                        to right,
                        rgba(255, 0, 0, 1),
                        rgba(255, 0, 180, 1),
                        rgba(0, 100, 200, 1)
                    );
                background-size:
                    100% 3px,
                    0 3px;
                background-position:
                    100% 100%,
                    0 100%;
                background-repeat: no-repeat;
                transition: background-size 400ms;
            }

            a:hover {
                background-size:
                    0 3px,
                    100% 3px;
            }
            .result {
                border-bottom: 1px solid var(--border-color);
                padding: 10px 0;
            }
            .result:last-child {
                border-bottom: none;
            }
            .result h3 {
                margin: 0 0 5px 0;
                color: var(--primary-color);
                font-size: 1em;
            }
            /*.result a { color: var(--link-color); text-decoration: none; font-size: 0.9em; }
            .result a:hover { text-decoration: underline; }*/
            .result p {
                margin: 5px 0 0 0;
            }

            #status {
                text-align: center;
                color: var(--text-color);
                padding: 10px;
                max-width: 800px;
                margin: 0 auto;
            }

            #search-footer {
                background-color: var(--bg-color);
                padding: 15px 20px;
                border-top: 1px solid var(--border-color);
            }
            .footer-content {
                max-width: 800px;
                margin: 0 auto;
            }
            #timeframe-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                justify-content: center;
            }
            .timeframe-btn {
                background-color: #3d3d3d;
                color: var(--text-color);
                border: 1px solid var(--border-color);
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
            }
            .timeframe-btn:hover {
                background-color: #4f4f4f;
            }
            .timeframe-btn.active {
                background-color: var(--primary-color);
                border-color: var(--button-hover-bg);
                color: white;
            }

            #search-form {
                display: flex;
                gap: 10px;
            }
            #query-input {
                flex-grow: 1;
                padding: 12px;
                font-size: 16px;
                border: 1px solid var(--border-color);
                border-radius: 5px;
                background-color: #3d3d3d;
                color: var(--text-color);
                outline: none;
            }
            #search-button {
                padding: 12px 20px;
                font-size: 16px;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            #search-button:disabled {
                background-color: var(--disabled-color);
                cursor: not-allowed;
            }
            .icon-button {
                background: none;
                border: 1px solid var(--border-color);
                color: var(--text-color);
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
            }

            /* --- Settings/Research Panel Specific --- */
            .settings-group {
                margin-bottom: 20px;
            }
            .settings-group label {
                display: block;
                margin-bottom: 5px;
            }
            .settings-group select,
            .settings-group textarea {
                width: 100%;
                padding: 8px;
                background-color: #3d3d3d;
                color: var(--text-color);
                border: 1px solid var(--border-color);
                border-radius: 4px;
                box-sizing: border-box;
            }

            #conversations-list {
                list-style: none;
                padding: 0;
                margin: 0;
                overflow-y: auto;
                flex-grow: 1;
            }
            #conversations-list li {
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                margin-bottom: 5px;
                border: 1px solid transparent;
            }
            #conversations-list li:hover {
                background-color: #3d3d3d;
            }
            #conversations-list li.active {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--button-hover-bg);
            }

            #new-chat-btn {
                width: 100%;
                padding: 10px;
                margin-bottom: 10px;
            }
            .db-actions {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }
            .db-actions button {
                flex: 1;
            }

            /* --- Notes Container --- */
            #notes-container {
                display: none;
                flex-direction: column;
                border-top: 1px solid var(--border-color);
                margin-top: 10px;
                padding-top: 10px;
            }
            #notes-textarea {
                height: 150px;
                resize: vertical;
                margin-bottom: 10px;
            }
            #save-notes-btn {
                width: 100%;
            }

            /* --- Loader Modal --- */
            #loader-modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 2000;
                justify-content: center;
                align-items: center;
            }
            #loader-modal {
                background: var(--container-bg);
                padding: 20px;
                border-radius: 8px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            }
            #db-files-list {
                list-style: none;
                padding: 0;
                max-height: 300px;
                overflow-y: auto;
            }
            #db-files-list li {
                padding: 10px;
                cursor: pointer;
                border-radius: 4px;
            }
            #db-files-list li:hover {
                background-color: var(--primary-color);
                color: white;
            }
        </style>
    </head>
    <body>
        <aside id="research-panel">
            <div class="panel-header">
                <h2>Research</h2>
                <button class="close-panel-btn" data-panel="research-panel">
                    &times;
                </button>
            </div>
            <button id="new-chat-btn" class="timeframe-btn">+ New Chat</button>
            <ul id="conversations-list"></ul>

            <!-- Notes Section -->
            <div id="notes-container">
                <h3>Notes</h3>
                <textarea
                    id="notes-textarea"
                    class="settings-group"
                    placeholder="Your curated notes..."
                ></textarea>
                <button id="save-notes-btn" class="timeframe-btn">
                    Save Notes
                </button>
            </div>

            <div class="db-actions">
                <button id="load-db-btn" class="timeframe-btn">Load DB</button>
                <button id="save-db-btn" class="timeframe-btn">Save DB</button>
            </div>
        </aside>

        <main id="main-content">
            <div id="chat-container"><div id="chat-log"></div></div>
            <div id="status"></div>
            <footer id="search-footer">
                <div class="footer-content">
                    <div id="timeframe-buttons">
                        <button class="timeframe-btn" data-timeframe="day">
                            Past 24 hours
                        </button>
                        <button class="timeframe-btn" data-timeframe="week">
                            Past week
                        </button>
                        <button class="timeframe-btn" data-timeframe="month">
                            Past month
                        </button>
                        <button class="timeframe-btn active" data-timeframe="">
                            All time
                        </button>
                    </div>
                    <form id="search-form">
                        <button
                            type="button"
                            class="icon-button"
                            id="research-toggle-btn"
                        >
                            üìö
                        </button>
                        <input
                            type="text"
                            id="query-input"
                            placeholder="Enter your search query..."
                            required
                            autocomplete="off"
                        />
                        <button type="submit" id="search-button">Search</button>
                        <button
                            type="button"
                            class="icon-button"
                            id="settings-toggle-btn"
                        >
                            ‚öôÔ∏è
                        </button>
                    </form>
                </div>
            </footer>
        </main>

        <aside id="settings-panel">
            <div class="panel-header">
                <h2>AI Settings</h2>
                <button class="close-panel-btn" data-panel="settings-panel">
                    &times;
                </button>
            </div>
            <div class="settings-group">
                <label for="provider-select">Provider</label
                ><select id="provider-select">
                    <option value="lmstudio">Local</option>
                    <option value="openai">OpenAI</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="google">Google</option>
                </select>
            </div>
            <div class="settings-group">
                <label for="model-select">Model</label
                ><select id="model-select">
                    <option>Loading models...</option>
                </select>
            </div>
            <div class="settings-group">
                <label for="system-prompt-input">System Prompt</label
                ><textarea id="system-prompt-input">
You are a helpful assistant that summarizes web search results and formats your response using Markdown.</textarea
                >
            </div>
        </aside>

        <div id="loader-modal-overlay">
            <div id="loader-modal">
                <div class="panel-header">
                    <h3>Load Database</h3>
                    <button id="close-loader-btn" class="close-panel-btn">
                        &times;
                    </button>
                </div>
                <ul id="db-files-list"></ul>
            </div>
        </div>

        <script>
            // --- DOM Elements ---
            const queryInput = document.getElementById("query-input"),
                searchButton = document.getElementById("search-button");
            const statusDiv = document.getElementById("status"),
                timeframeButtonsContainer =
                    document.getElementById("timeframe-buttons");
            const chatLog = document.getElementById("chat-log"),
                chatContainer = document.getElementById("chat-container");

            // --- Panels & Modals ---
            const researchPanel = document.getElementById("research-panel"),
                settingsPanel = document.getElementById("settings-panel");
            const researchToggleBtn = document.getElementById(
                    "research-toggle-btn",
                ),
                settingsToggleBtn = document.getElementById(
                    "settings-toggle-btn",
                );
            const newChatBtn = document.getElementById("new-chat-btn"),
                conversationsList =
                    document.getElementById("conversations-list");
            const saveDbBtn = document.getElementById("save-db-btn"),
                loadDbBtn = document.getElementById("load-db-btn");
            const loaderModalOverlay = document.getElementById(
                    "loader-modal-overlay",
                ),
                dbFilesList = document.getElementById("db-files-list"),
                closeLoaderBtn = document.getElementById("close-loader-btn");

            // --- Notes ---
            const notesContainer = document.getElementById("notes-container");
            const notesTextarea = document.getElementById("notes-textarea");
            const saveNotesBtn = document.getElementById("save-notes-btn");

            // --- Settings ---
            const providerSelect = document.getElementById("provider-select"),
                modelSelect = document.getElementById("model-select"),
                systemPromptInput = document.getElementById(
                    "system-prompt-input",
                );

            // --- State ---
            let selectedTimeframe = "",
                currentConversationId = null;

            // --- Marked.js & Highlight.js Setup ---
            marked.setOptions({
                gfm: true,
                breaks: true,
                highlight: (code, lang) =>
                    hljs.highlight(code, {
                        language: hljs.getLanguage(lang) ? lang : "plaintext",
                    }).value,
            });

            // --- Panel & Modal Logic ---
            researchToggleBtn.addEventListener("click", () =>
                researchPanel.classList.toggle("visible"),
            );
            settingsToggleBtn.addEventListener("click", () =>
                settingsPanel.classList.toggle("visible"),
            );
            document
                .querySelectorAll(".close-panel-btn")
                .forEach((btn) =>
                    btn.addEventListener("click", () =>
                        document
                            .getElementById(btn.dataset.panel)
                            ?.classList.remove("visible"),
                    ),
                );
            closeLoaderBtn.addEventListener(
                "click",
                () => (loaderModalOverlay.style.display = "none"),
            );

            // --- Model Loading Logic ---
            async function fetchModels(provider) {
                modelSelect.innerHTML = "<option>Loading models...</option>";
                try {
                    const res = await fetch(`/api/models?provider=${provider}`);
                    if (!res.ok) throw new Error("Failed to fetch models.");
                    const models = await res.json();
                    modelSelect.innerHTML =
                        models.length > 0
                            ? models
                                  .map(
                                      (m) =>
                                          `<option value="${m.id}">${m.name}</option>`,
                                  )
                                  .join("")
                            : "<option>No models found.</option>";
                } catch (error) {
                    modelSelect.innerHTML = `<option>Error loading models</option>`;
                }
            }
            providerSelect.addEventListener("change", () =>
                fetchModels(providerSelect.value),
            );

            // --- Conversation & Notes Management ---
            async function loadConversations() {
                try {
                    const res = await fetch("/api/conversations");
                    const convos = await res.json();
                    conversationsList.innerHTML = convos
                        .map(
                            (c) =>
                                `<li data-id="${c.id}" class="${c.id === currentConversationId ? "active" : ""}">${c.title}</li>`,
                        )
                        .join("");
                } catch (error) {
                    conversationsList.innerHTML =
                        "<li>Error loading chats</li>";
                }
            }

            async function loadConversation(id) {
                try {
                    const res = await fetch(`/api/conversations/${id}`);
                    const convo = await res.json();
                    chatLog.innerHTML = "";
                    convo.messages.forEach((msg) =>
                        appendMessage(
                            msg.role,
                            msg.content,
                            JSON.parse(msg.sources || "[]"),
                        ),
                    );
                    currentConversationId = id;

                    notesTextarea.value = convo.note_content || "";
                    notesContainer.style.display = "flex";

                    document
                        .querySelectorAll("#conversations-list li")
                        .forEach((li) =>
                            li.classList.toggle(
                                "active",
                                parseInt(li.dataset.id) === id,
                            ),
                        );
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } catch (error) {
                    console.error("Failed to load conversation:", error);
                }
            }

            function startNewChat() {
                currentConversationId = null;
                chatLog.innerHTML = "";
                notesContainer.style.display = "none";
                notesTextarea.value = "";
                document
                    .querySelectorAll("#conversations-list li.active")
                    .forEach((li) => li.classList.remove("active"));
            }
            newChatBtn.addEventListener("click", startNewChat);

            conversationsList.addEventListener("click", (e) => {
                if (e.target.tagName === "LI") {
                    const id = parseInt(e.target.dataset.id);
                    if (id !== currentConversationId) loadConversation(id);
                }
            });

            saveNotesBtn.addEventListener("click", async () => {
                if (!currentConversationId)
                    return alert("Please select a conversation first.");
                const content = notesTextarea.value;
                saveNotesBtn.textContent = "Saving...";
                try {
                    const res = await fetch(
                        `/api/conversations/${currentConversationId}/notes`,
                        {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ content }),
                        },
                    );
                    if (!res.ok) throw new Error("Failed to save notes.");
                    saveNotesBtn.textContent = "Saved!";
                    setTimeout(
                        () => (saveNotesBtn.textContent = "Save Notes"),
                        2000,
                    );
                } catch (error) {
                    alert("Error: " + error.message);
                    saveNotesBtn.textContent = "Save Notes";
                }
            });

            // --- DB Persistence Logic ---
            saveDbBtn.addEventListener("click", async () => {
                const filename = prompt(
                    "Enter filename for database:",
                    "research.db",
                );
                if (!filename) return;
                try {
                    const res = await fetch("/api/research/save", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ filename }),
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error);
                    alert(data.message);
                } catch (error) {
                    alert(`Error saving database: ${error.message}`);
                }
            });

            loadDbBtn.addEventListener("click", async () => {
                try {
                    const res = await fetch("/api/research/files");
                    const files = await res.json();
                    if (files.length === 0)
                        return alert("No database files found on server.");
                    dbFilesList.innerHTML = files
                        .map((f) => `<li>${f}</li>`)
                        .join("");
                    loaderModalOverlay.style.display = "flex";
                } catch (error) {
                    alert("Could not fetch database file list.");
                }
            });

            dbFilesList.addEventListener("click", async (e) => {
                if (e.target.tagName !== "LI") return;
                const filename = e.target.textContent;
                try {
                    const res = await fetch("/api/research/load", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ filename }),
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || data.message);
                    alert(data.message);
                    loaderModalOverlay.style.display = "none";
                    await loadConversations();
                    startNewChat();
                } catch (error) {
                    alert(`Error loading database: ${error.message}`);
                }
            });

            // --- Main Search/Query Logic ---
            document
                .getElementById("search-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const query = queryInput.value.trim();
                    if (!query) return;

                    searchButton.disabled = true;
                    statusDiv.textContent = "Thinking...";
                    appendMessage("user", query);
                    queryInput.value = "";

                    if (!currentConversationId) {
                        try {
                            const res = await fetch("/api/conversations", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    title: query.substring(0, 50),
                                }),
                            });
                            const newConvo = await res.json();
                            currentConversationId = newConvo.id;
                            await loadConversations();
                            notesContainer.style.display = "flex"; // Show notes section for new chat
                        } catch (error) {
                            statusDiv.textContent =
                                "Error creating new conversation.";
                            searchButton.disabled = false;
                            return;
                        }
                    }

                    const settings = {
                        query,
                        timeframe: selectedTimeframe,
                        provider: providerSelect.value,
                        model: modelSelect.value,
                        systemPrompt: systemPromptInput.value,
                    };
                    let assistantMessageDiv,
                        contentDiv,
                        fullSummaryText = "",
                        sources = [];

                    try {
                        const response = await fetch(
                            `/api/conversations/${currentConversationId}/query`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(settings),
                            },
                        );
                        if (!response.ok || !response.body)
                            throw new Error("Network response was not ok.");

                        const reader = response.body.getReader(),
                            decoder = new TextDecoder();
                        let buffer = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split("\n\n");
                            buffer = lines.pop() || "";
                            for (const line of lines) {
                                if (!line.startsWith("event:")) continue;
                                const eventType = line.match(/event: (.*)/)[1];
                                const data = JSON.parse(
                                    line.match(/data: (.*)/)[1],
                                );
                                if (eventType === "results") sources = data;
                                else if (
                                    eventType === "summary-start" &&
                                    !assistantMessageDiv
                                ) {
                                    ({
                                        div: assistantMessageDiv,
                                        content: contentDiv,
                                    } = appendMessage(
                                        "assistant",
                                        "...",
                                        sources,
                                    ));
                                } else if (eventType === "summary-chunk") {
                                    fullSummaryText += data.text;
                                    if (contentDiv)
                                        contentDiv.innerHTML =
                                            marked.parse(fullSummaryText);
                                } else if (eventType === "error")
                                    statusDiv.textContent = `An error occurred: ${data.message}`;
                            }
                        }
                    } catch (error) {
                        statusDiv.textContent = `Error: ${error.message}`;
                    } finally {
                        searchButton.disabled = false;
                        statusDiv.textContent = "";
                        hljs.highlightAll();
                    }
                });

            function appendMessage(role, content, sources = []) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${role}`;
                const contentDiv = document.createElement("div");
                contentDiv.className = "content";
                contentDiv.innerHTML = marked.parse(content);
                messageDiv.appendChild(contentDiv);

                if (role === "assistant" && sources.length > 0) {
                    const sourcesContainer = document.createElement("div");
                    sourcesContainer.className = "sources-container";
                    sourcesContainer.innerHTML = `<span class="sources-toggle">Show ${sources.length} Sources ‚ñº</span>`;
                    const sourcesList = document.createElement("div");
                    sourcesList.className = "sources-list";
                    sourcesList.innerHTML = sources
                        .map(
                            (s) =>
                                `<div class="result"><h3>${s.title}</h3><p>${s.content}</p><a href="${s.url}" target="_blank" rel="noopener noreferrer">${s.url}</a></div>`,
                        )
                        .join("");
                    sourcesContainer.appendChild(sourcesList);
                    messageDiv.appendChild(sourcesContainer);
                }

                chatLog.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return { div: messageDiv, content: contentDiv };
            }

            chatLog.addEventListener("click", (e) => {
                if (e.target.classList.contains("sources-toggle")) {
                    const list = e.target.nextElementSibling,
                        isVisible = list.style.display === "block";
                    list.style.display = isVisible ? "none" : "block";
                    e.target.textContent = isVisible
                        ? `Show ${list.children.length} Sources ‚ñº`
                        : `Hide ${list.children.length} Sources ‚ñ≤`;
                }
            });

            timeframeButtonsContainer.addEventListener("click", (e) => {
                if (e.target.tagName === "BUTTON") {
                    timeframeButtonsContainer
                        .querySelector(".active")
                        ?.classList.remove("active");
                    e.target.classList.add("active");
                    selectedTimeframe = e.target.dataset.timeframe;
                }
            });

            // --- Initial Load ---
            document.addEventListener("DOMContentLoaded", () => {
                fetchModels(providerSelect.value);
                loadConversations();
            });
        </script>
    </body>
</html>
